<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Safety Watch - Safety Observation Intelligence</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Chart.js for charting -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- html2canvas for capturing HTML as image -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* General Body and Container Styling */
        body {
            font-family: 'Inter', sans-serif; /* Using Inter font as per instructions */
            margin: 0;
            background-color: #eef2f6; /* Light gray background */
            color: #333;
        }
        .container {
            max-width: 1200px; /* Wider container for dashboard feel */
            margin: 20px auto;
            background: #ffffff;
            padding: 0; /* Remove padding here, will add to sections */
            border-radius: 12px; /* More rounded corners */
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); /* Softer, larger shadow */
            overflow: hidden; /* Ensures rounded corners apply to children */
        }

        /* Header Branding (Logo, Title, Company Name) */
        .header-branding {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 30px; /* Padding for the header */
            background-color: #2c3e50; /* Dark blue background */
            color: #ecf0f1;
            border-radius: 8px 8px 0 0; /* Rounded top corners */
        }
        .header-branding .left-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .header-branding .logo-title {
            display: flex;
            flex-direction: column;
            align-items: flex-start; /* Align text to the left */
        }
        .header-branding .logo {
            height: 40px; /* Larger logo */
            width: auto;
            border-radius: 4px;
        }
        .header-branding .main-title {
            font-weight: 700;
            font-size: 1.5em; /* Main title size in header */
            margin: 0;
            line-height: 1.2;
        }
        .header-branding .company-info {
            font-size: 0.9em;
            opacity: 0.8;
            margin-top: 5px;
        }
        .header-branding .data-status { /* Renamed from data-verified for dynamic styling */
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9em;
            font-weight: 600;
            padding: 5px 10px;
            border-radius: 5px;
            transition: background-color 0.3s ease, color 0.3s ease; /* Smooth transition */
        }
        .header-branding .data-status.verified { /* Green for verified */
            color: #2ecc71; 
            background-color: rgba(46, 204, 113, 0.2); 
        }
        .header-branding .data-status.unverified { /* Red for unverified */
            color: #e74c3c; 
            background-color: rgba(231, 76, 60, 0.2); 
        }

        /* Top Navigation Bar (Tabs) */
        .navbar {
            background-color: #ffffff; /* White background for tabs section */
            padding: 0 30px; /* Match container padding */
            display: flex;
            justify-content: flex-start; /* Align tabs to the left */
            border-bottom: 1px solid #e0e0e0; /* Separator line */
        }
        .navbar a {
            color: #34495e; /* Darker text for inactive tabs */
            text-decoration: none;
            padding: 15px 25px; /* Larger padding for tabs */
            margin-right: 5px; /* Small gap between tabs */
            border-bottom: 3px solid transparent; /* For active tab indicator */
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 1em;
        }
        .navbar a:hover {
            color: #3498db; /* Blue on hover */
            border-bottom-color: #3498db;
        }
        .navbar a.active {
            color: #3498db; /* Active tab color */
            border-bottom-color: #3498db; /* Blue underline for active tab */
            background-color: #f8f8f8; /* Slightly different background for active tab */
        }
        .navbar a.disabled-tab { /* Style for disabled tabs */
            pointer-events: none; /* Disable clicks */
            opacity: 0.6; /* Dim them */
            cursor: not-allowed;
        }

        /* Content Area Padding */
        .content-area {
            padding: 30px; /* Add padding back to the content area */
        }
        .tab-content {
            display: none; /* Hidden by default */
        }
        .tab-content.active {
            display: block; /* Show active tab content */
        }

        /* Home Tab Specific Styles */
        .home-grid {
            display: grid;
            grid-template-columns: 1fr 1.2fr 1.8fr; /* Adjusted: Left, Center (smaller), Right (larger) */
            gap: 20px;
            padding: 20px 0;
            align-items: stretch; /* Stretch items to fill height */
        }
        @media (max-width: 900px) {
            .home-grid {
                grid-template-columns: 1fr; /* Stack columns on smaller screens */
            }
        }

        .home-card {
            background-color: #fcfcfc;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .home-card.left {
            background-color: #34495e; /* Dark blue background for left card */
            color: white;
        }
        .home-card.center {
            background-color: #2c3e50; /* Darker blue background for center card */
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .home-card.right {
            background-color: #f39c12; /* Orange background for right card */
            color: white;
        }

        .home-card h3 {
            font-size: 1.4em;
            margin-top: 0;
            margin-bottom: 20px;
            font-weight: 600;
        }
        .home-card p {
            font-size: 1.1em;
            line-height: 1.6;
        }

        /* Left Card - Calibrator */
        .calibrator-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }
        .calibrator-buttons a {
            background-color: #4a6078; /* Darker, more solid background */
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 500;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            flex: 1 1 calc(50% - 10px); /* Two columns per row */
            max-width: calc(50% - 10px);
            box-sizing: border-box;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); /* Subtle shadow for depth */
        }
        .calibrator-buttons a:hover {
            background-color: #5a708a; /* Slightly lighter on hover */
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .reporting-period {
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .reporting-period span {
            background-color: rgba(255,255,255,0.25); /* More opaque white */
            padding: 8px 12px; /* Increased padding */
            border-radius: 8px; /* More rounded */
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); /* Subtle shadow */
        }

        /* Center Card - Welcome */
        .welcome-message {
            font-size: 1.6em;
            font-weight: 700;
            color: #f39c12; /* Orange for "Safety Excellence Dashboard" */
            margin-bottom: 20px;
        }
        .welcome-text {
            font-size: 1.1em;
            line-height: 1.6;
            color: white; /* White text for welcome message */
        }

        /* Right Card - Core Capabilities */
        .capabilities-list {
            list-style: none;
            padding: 0;
            text-align: left;
        }
        .capabilities-list li {
            background-color: rgba(255,255,255,0.15);
            padding: 10px 15px;
            margin-bottom: 8px;
            border-radius: 8px;
            font-weight: 500;
            transition: background-color 0.3s ease;
        }
        .capabilities-list li:hover {
            background-color: rgba(255,255,255,0.3);
        }

        /* File Upload Area */
        .file-upload-section {
            border: 2px dashed #bdc3c7; /* Dashed border for upload area */
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            margin-bottom: 30px;
            background-color: #fcfcfc;
            transition: border-color 0.3s ease;
        }
        .file-upload-section:hover {
            border-color: #3498db; /* Blue border on hover */
        }
        .file-upload-section i {
            font-size: 3em;
            color: #3498db;
            margin-bottom: 15px;
        }
        .file-upload-section p {
            margin: 0;
            font-size: 1.1em;
            color: #555;
        }
        .file-upload-section input[type="file"] {
            display: none; /* Hide default file input */
        }
        .custom-file-upload {
            display: inline-block;
            background-color: #3498db; /* Blue button for file selection */
            color: white;
            padding: 10px 25px;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 20px;
            font-weight: 600;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .custom-file-upload:hover {
            background-color: #2980b9;
            transform: translateY(-1px);
        }
        #fileNameDisplay {
            margin-top: 10px;
            font-style: italic;
            color: #777;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            justify-content: center; /* Center the buttons */
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        .action-buttons button {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 3px 8px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Specific Button Styles */
        .process-button {
            background: linear-gradient(145deg, #2ecc71, #27ae60); /* Green gradient */
            color: white;
        }
        .process-button:hover {
            background: linear-gradient(145deg, #27ae60, #2ecc71);
            transform: translateY(-2px);
            box-shadow: 0 5px 12px rgba(0,0,0,0.2);
        }

        .clear-button { 
            background: linear-gradient(145deg, #e74c3c, #c0392b); /* Red gradient */
            color: white;
        }
        .clear-button:hover {
            background: linear-gradient(145deg, #c0392b, #e74c3c);
            transform: translateY(-2px);
            box-shadow: 0 5px 12px rgba(0,0,0,0.2);
        }

        .add-row-button { 
            background: linear-gradient(145deg, #3498db, #2980b9); /* Blue gradient */
            color: white;
        }
        .add-row-button:hover {
            background: linear-gradient(145deg, #2980b9, #3498db);
            transform: translateY(-2px);
            box-shadow: 0 5px 12px rgba(0,0,0,0.2);
        }

        .export-button { 
            background: linear-gradient(145deg, #f39c12, #e67e22); /* Orange gradient */
            color: white;
        }
        .export-button:hover {
            background: linear-gradient(145deg, #e67e22, #f39c12);
            transform: translateY(-2px);
            box-shadow: 0 5px 12px rgba(0,0,0,0.2);
        }
        .template-button { /* New style for template buttons */
            background: linear-gradient(145deg, #9b59b6, #8e44ad); /* Purple gradient */
            color: white;
        }
        .template-button:hover {
            background: linear-gradient(145deg, #8e44ad, #9b59b6);
            transform: translateY(-2px);
            box-shadow: 0 5px 12px rgba(0,0,0,0.2);
        }

        /* Status Message */
        #statusMessage {
            margin-top: 10px;
            padding: 10px;
            border-radius: 6px;
            text-align: center;
            font-weight: bold;
            color: #2c3e50;
            background-color: #dbe4ee;
        }
        #statusMessage.success {
            background-color: #d4edda;
            color: #155724;
        }
        #statusMessage.warning {
            background-color: #fff3cd;
            color: #856404;
        }
        #statusMessage.error {
            background-color: #f8d7da;
            color: #721c24;
        }

        /* Data Table Styling */
        #dataContainer {
            max-height: 500px; /* Increased height for more data visibility */
            overflow-x: auto; 
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            box-shadow: inset 0 0 8px rgba(0,0,0,0.05);
        }
        #dataTable {
            width: 100%;
            border-collapse: separate; /* Use separate for rounded corners */
            border-spacing: 0; /* Remove default spacing */
            margin-top: 0; /* Remove top margin as it's in dataContainer */
            font-size: 0.9em;
            min-width: 1000px; /* Ensure table doesn't shrink too much */
        }
        #dataTable th, #dataTable td {
            border: 1px solid #e0e0e0;
            padding: 12px 10px; /* More padding */
            text-align: left;
            vertical-align: middle;
            white-space: nowrap; /* Prevent text wrapping in cells */
        }
        #dataTable th {
            background-color: #3498db; /* Blue header */
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
            text-transform: uppercase;
            font-size: 0.85em;
        }
        #dataTable tbody tr:nth-child(even) {
            background-color: #f8f8f8; /* Zebra striping */
        }
        #dataTable tbody tr:hover {
            background-color: #eef7ff; /* Light blue on row hover */
        }
        #dataTable td[contenteditable="true"] {
            background-color: #ffffff;
            border: 1px dashed #c0c0c0;
            padding: 7px; /* Slightly less padding for editable cells */
            border-radius: 4px;
        }
        #dataTable td input[type="date"],
        #dataTable td input[type="datetime-local"] {
            width: calc(100% - 10px); /* Adjust width for padding */
            box-sizing: border-box;
            border: 1px solid #c0c0c0;
            padding: 5px;
            border-radius: 4px;
            font-size: 1em;
        }
        #dataTable td input[type="date"]:focus,
        #dataTable td input[type="datetime-local"]:focus,
        #dataTable td[contenteditable="true"]:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 5px rgba(52, 152, 219, 0.5);
        }
        
        /* Placeholder for empty table */
        #dataTable tbody tr td[colspan="20"] {
            text-align: center;
            color: #a0a0a0;
            padding: 50px;
            font-style: italic;
        }

        /* Executive Command Center Styles */
        .ecc-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            background-color: #2c3e50; /* Dark blue background */
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
        }
        .ecc-header h2 {
            margin: 0;
            font-size: 1.8em;
            font-weight: 700;
            text-align: left; /* Align left */
        }
        .ecc-header .date-range-picker {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .ecc-header .date-range-picker input[type="date"] {
            padding: 8px 12px;
            border-radius: 5px;
            border: 1px solid #ccc;
            background-color: white;
            color: #333;
            font-size: 0.9em;
        }

        .ecc-metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); /* Responsive columns */
            gap: 20px;
            margin-bottom: 30px;
        }
        .metric-card {
            background-color: #34495e; /* Dark blue */
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .metric-card.orange {
            background-color: #f39c12; /* Orange */
        }
        .metric-card h4 {
            margin: 0 0 10px 0;
            font-size: 1em;
            opacity: 0.8;
        }
        .metric-card .value {
            font-size: 2.2em;
            font-weight: 700;
            margin-bottom: 5px;
        }
        .metric-card .trend {
            font-size: 0.9em;
            opacity: 0.7;
        }
        .trend .up { color: #2ecc71; } /* Green for up */
        .trend .down { color: #e74c3c; } /* Red for down */
        .trend .flat { color: #f1c40f; } /* Yellow for flat */

        .ecc-charts-grid {
            display: grid;
            grid-template-columns: 1fr 2fr; /* Left table, right charts */
            gap: 20px;
            margin-bottom: 30px;
        }
        @media (max-width: 900px) {
            .ecc-charts-grid {
                grid-template-columns: 1fr; /* Stack on smaller screens */
            }
        }

        .ecc-chart-card {
            background-color: #ffffff;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 250px; /* Ensure charts have some height */
        }
        .ecc-chart-card h4 {
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.2em;
            color: #34495e;
            font-weight: 600;
        }

        .zone-risk-table-container { /* New container for scrollbar */
            max-height: 200px; /* Max height for scroll */
            overflow-y: auto; /* Enable vertical scroll */
            width: 100%; /* Take full width of parent */
            border: 1px solid #e0e0e0; /* Optional: add border to container */
            border-radius: 8px;
        }

        .zone-risk-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }
        .zone-risk-table th, .zone-risk-table td {
            border: 1px solid #e0e0e0;
            padding: 8px 12px;
            text-align: left;
        }
        .zone-risk-table th {
            background-color: #3498db;
            color: white;
            font-weight: 600;
            position: sticky; /* Make header sticky during scroll */
            top: 0;
            z-index: 1;
        }
        .zone-risk-table tbody tr:nth-child(even) {
            background-color: #f8f8f8;
        }
        .zone-risk-table .risk-high { background-color: #e74c3c; color: white; }
        .zone-risk-table .risk-medium { background-color: #f1c40f; color: #333; }
        .zone-risk-table .risk-low { background-color: #2ecc71; color: white; }

        /* Speedometer Gauge Styling */
        .active-risk-gauge {
            width: 250px; /* Larger width */
            height: 125px; /* Half of width for semi-circle */
            position: relative;
            margin: 20px auto 40px auto; /* More margin at bottom for labels */
            overflow: hidden; /* Hide the bottom half of the circle */
            border-radius: 125px 125px 0 0; /* Semi-circle top */
            background-color: #e0e0e0; /* Neutral background for the gauge track */
            box-shadow: inset 0 0 10px rgba(0,0,0,0.1);
            border-bottom: none; /* No bottom border for the semi-circle */
        }

        .gauge-arc {
            width: 100%;
            height: 100%;
            border-radius: 125px 125px 0 0;
            position: absolute;
            top: 0;
            left: 0;
            /* This will be set dynamically by JS based on risk level */
            background-color: #bdc3c7; /* Default/fallback color */
            clip-path: polygon(0 100%, 0 0, 100% 0, 100% 100%); /* Ensures it's a semi-circle */
            z-index: 1;
        }

        .gauge-center {
            width: 100px; /* Size of the inner circle */
            height: 100px;
            background-color: #2c3e50; /* Dark center for contrast */
            border-radius: 50%;
            position: absolute;
            /* Adjust positioning to ensure value is visible */
            bottom: -30px; /* Move it up slightly so it doesn't hide the value */
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2em; /* Larger font for value */
            font-weight: bold;
            z-index: 2;
            box-shadow: 0 -5px 10px rgba(0,0,0,0.2);
        }
        .gauge-value-display {
            font-size: 1.5em; /* Adjusted font size for value inside gauge to fit better */
            color: white;
            position: relative; /* Ensure it respects parent's flexbox */
            top: -10px; /* Fine-tune vertical alignment */
        }

        .gauge-needle {
            width: 4px; /* Needle thickness */
            height: 100px; /* Needle length */
            background-color: black; /* Solid black needle */
            position: absolute;
            bottom: 0;
            left: 50%;
            transform-origin: bottom center; /* Rotate from the bottom */
            transform: translateX(-50%) rotate(0deg); /* Default to 0 risk */
            transition: transform 0.5s ease-out; /* Smooth rotation */
            z-index: 3;
        }

        .gauge-labels {
            display: flex;
            justify-content: space-between;
            width: 100%;
            position: absolute;
            bottom: -20px; /* Position below the gauge */
            left: 0;
            padding: 0 10px;
            box-sizing: border-box;
            font-size: 0.9em;
            color: #555;
            z-index: 4; /* Ensure labels are above other elements */
        }
        .gauge-labels span:first-child { text-align: left; }
        .gauge-labels span:last-child { text-align: right; }
        .gauge-goal {
            font-size: 0.9em;
            color: #555;
            margin-top: 10px;
        }

        .chart-placeholder {
            background-color: #ecf0f1; /* Light gray for chart areas */
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            color: #777;
            font-style: italic;
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .ecc-critical-obs-table-container { /* New container for critical obs table */
            max-height: 300px; /* Set a max height */
            overflow-y: auto; /* Enable vertical scroll */
            width: 100%;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }
        .ecc-critical-obs-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }
        .ecc-critical-obs-table th, .ecc-critical-obs-table td {
            border: 1px solid #e0e0e0;
            padding: 8px 12px;
            text-align: left;
        }
        .ecc-critical-obs-table th {
            background-color: #e74c3c; /* Red header for critical obs */
            color: white;
            font-weight: 600;
            position: sticky; /* Make header sticky */
            top: 0;
            z-index: 1;
        }
        .ecc-critical-obs-table tbody tr:nth-child(even) {
            background-color: #f8f8f8;
        }
        .ecc-critical-obs-table .critical-cell {
            background-color: #fbe6e6; /* Light red for critical count */
            font-weight: bold;
        }
        .ecc-critical-obs-table .yellow-cell {
            background-color: #fffacd; /* Light yellow for yellow cells */
        }
    </style>
</head>
<body>

<div class="container">
    <!-- Updated Header Branding Section -->
    <div class="header-branding">
        <div class="left-section">
            <img src="my_company_logo.png" alt="Company Logo" class="logo"> <!-- Reverted logo source -->
            <div class="logo-title">
                <p class="main-title">Digital Safety Watch - Safety Observation Intelligence</p> <!-- Main title is now above -->
                <p class="company-info">Powered By | &copy; AKD-Digi-Tech</p> <!-- Copyright moved -->
            </div>
        </div>
        <div class="data-status unverified" id="dataStatus">
            <i class="fas fa-exclamation-triangle"></i> Data Unverified
        </div>
    </div>

    <!-- Navigation Bar (Tabs) -->
    <div class="navbar">
        <a href="#" class="tab-link" data-tab="home">Home</a>
        <a href="#" class="tab-link disabled-tab" data-tab="executive-command">Executive Command Center</a>
        <a href="#" class="tab-link disabled-tab" data-tab="root-cause-analysis">Root Cause Analysis</a> <!-- New tab link -->
        <a href="#" class="tab-link active" data-tab="data-input">Data Input</a>
    </div>

    <div class="content-area">
        <!-- Home Tab Content -->
        <div id="home-tab" class="tab-content">
            <div class="home-grid">
                <div class="home-card left">
                    <h3>Your On-Ground Safety Excellence Calibrator</h3>
                    <div class="reporting-period">
                        Reporting Period: <span id="reportPeriodStart">--</span> <i class="fas fa-arrow-left"></i> <i class="fas fa-arrow-right"></i> <span id="reportPeriodEnd">--</span>
                    </div>
                    <div class="calibrator-buttons">
                        <a href="#">Culture Insights</a>
                        <a href="#">Accountability Hub</a>
                        <a href="#">Executive Command</a>
                        <a href="#">Root Cause Analysis</a>
                        <a href="#">Vulnerability Forecast</a>
                        <a href="#">Data Entry</a>
                    </div>
                </div>
                <div class="home-card center">
                    <p class="welcome-message">Welcome to your Safety Excellence Dashboard</p>
                    <p class="welcome-text">Navigate through the different sections to monitor real-time risk, track accountability, and gain valuable insights into your safety culture.</p>
                </div>
                <div class="home-card right">
                    <h3>CORE CAPABILITIES</h3>
                    <ul class="capabilities-list">
                        <li>Real-Time Risk Monitoring & Alerting</li>
                        <li>Action Accountability & Performance Tracking</li>
                        <li>Root Cause Intelligence & Pattern Identification</li>
                        <li>Safety Culture Assessment & Engagement Insights</li>
                        <li>Vulnerability Forecasting & Prevention Prioritization</li>
                        <li>MASTER LIST: Reference</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Data Input Tab Content -->
        <div id="data-input-tab" class="tab-content active">
            <div class="file-upload-section">
                <label for="fileInput" class="custom-file-upload">
                    <i class="fas fa-cloud-upload-alt"></i> Choose Excel/CSV File
                </label>
                <input type="file" id="fileInput" accept=".xlsx, .xls, .csv">
                <p id="fileNameDisplay">No file chosen</p>
                <p>Upload your Excel data in CSV format to populate the table</p>
            </div>

            <div class="action-buttons">
                <button id="processBtn" class="process-button"><i class="fas fa-play-circle"></i> Process Data</button>
                <button id="clearBtn" class="clear-button"><i class="fas fa-eraser"></i> Clear Data</button>
                <button id="addRowBtn" class="add-row-button"><i class="fas fa-plus-circle"></i> Add New Row</button>
                <button id="exportBtn" class="export-button"><i class="fas fa-file-export"></i> Export Data</button>
                <button id="downloadExcel" class="template-button"><i class="fas fa-file-excel"></i> Excel Template</button>
                <button id="downloadCSV" class="template-button"><i class="fas fa-file-csv"></i> CSV Template</button>
                <button id="generatePdfBtn" class="export-button" disabled><i class="fas fa-file-pdf"></i> Generate PDF</button> <!-- New PDF button -->
            </div>

            <p id="statusMessage"></p>

            <div id="dataContainer">
                <table id="dataTable">
                    <thead>
                        <tr></tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="20">Your data will appear here after processing or manual entry.</td></tr>
                </tbody>
            </table>
        </div>
    </div>

        <!-- Executive Command Center Tab Content -->
        <div id="executive-command-tab" class="tab-content">
            <div class="ecc-header">
                <h2>Executive Command Center</h2>
                <div class="date-range-picker">
                    Date: <input type="date" id="eccStartDate" value="2025-05-01"> - <input type="date" id="eccEndDate" value="2025-07-26">
                </div>
            </div>

            <div class="ecc-metrics-grid">
                <div class="metric-card">
                    <h4>Total Observations</h4>
                    <div class="value" id="totalObservations">0 <span class="trend"><i class="fas fa-caret-up up"></i> N/A</span></div>
                </div>
                <div class="metric-card">
                    <h4>Total GP</h4>
                    <div class="value" id="totalGP">0 <span class="trend"><i class="fas fa-caret-up up"></i> N/A</span></div>
                </div>
                <div class="metric-card">
                    <h4>Open Observations</h4>
                    <div class="value" id="openObservations">0 <span class="trend"><i class="fas fa-caret-up up"></i> N/A</span></div>
                </div>
                <div class="metric-card orange">
                    <h4>Total Overdue</h4>
                    <div class="value" id="totalOverdue">0 <span class="trend"><i class="fas fa-caret-up up"></i> N/A</span></div>
                </div>
                <div class="metric-card orange">
                    <h4>Open Overdue</h4>
                    <div class="value" id="openOverdue">0 <span class="trend"><i class="fas fa-caret-up up"></i> N/A</span></div>
                </div>
            </div>

            <div class="ecc-charts-grid">
                <div class="ecc-chart-card">
                    <h4>Active Zone Risk Index</h4> <!-- Renamed title -->
                    <div class="zone-risk-table-container"> <!-- Added container for scrollbar -->
                        <table class="zone-risk-table" id="zoneRiskTable">
                            <thead>
                                <tr>
                                    <th>Zone</th>
                                    <th>Risk Index</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Dynamic content here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="ecc-chart-card">
                    <h4>Active Organizational Risk Index</h4> <!-- Renamed title -->
                    <div class="active-risk-gauge" id="activeRiskGauge">
                        <div class="gauge-arc"></div>
                        <div class="gauge-center"><span class="gauge-value-display">0.00</span></div>
                        <div class="gauge-needle"></div>
                    </div>
                    <div class="gauge-labels">
                        <span>0</span>
                        <span>25</span>
                    </div>
                    <p class="gauge-goal">Goal: 4K (-200%)</p>
                </div>
            </div>

            <div class="ecc-charts-grid">
                <div class="ecc-chart-card" style="grid-column: span 2;">
                    <h4>Zone OBS Severity Trends</h4>
                    <div style="width: 100%; max-height: 400px;"> <!-- Container for chart -->
                        <canvas id="zoneSeverityChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="ecc-charts-grid">
                <div class="ecc-chart-card">
                    <h4>Open OBS & Overdue Trend</h4>
                    <div style="width: 100%; max-height: 400px;"> <!-- Container for chart -->
                        <canvas id="openOverdueTrendChart"></canvas>
                    </div>
                </div>
                <div class="ecc-chart-card">
                    <h4>Observations Average Age (Days Before Close)</h4>
                    <div style="width: 100%; max-height: 400px;"> <!-- Container for chart -->
                        <canvas id="observationsAverageAgeChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="ecc-charts-grid">
                <div class="ecc-chart-card" style="grid-column: span 2;">
                    <h4>REAL-TIME RISK - Active Critical OBS</h4>
                    <div class="ecc-critical-obs-table-container"> <!-- Added container for scroll -->
                        <table class="ecc-critical-obs-table" id="criticalObsTable">
                            <thead>
                                <tr>
                                    <th>Zone</th>
                                    <th>Fall Protection</th>
                                    <th>Fire Safety</th>
                                    <th>Good Practice</th>
                                    <th>Housekeeping</th>
                                    <th>Electrical Safety</th>
                                    <th>LOTO</th>
                                    <th>Machine Guarding</th>
                                    <th>Confined Space</th>
                                    <th>First Aid</th>
                                    <th>Hazard Communication</th>
                                    <th>Ergonomics</th>
                                    <th>Emergency Preparedness</th>
                                    <th>Traffic Safety</th>
                                    <th>Noise Exposure</th>
                                    <th>Welding/Cutting</th>
                                    <th>Total Active</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Dynamic content here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>

        <!-- Root Cause Analysis Tab Content -->
        <div id="root-cause-analysis-tab" class="tab-content">
            <div class="rca-header ecc-header"> <!-- Reusing ecc-header for consistent look -->
                <h2>Root Cause Analysis</h2>
                <div class="date-range-picker">
                    Date: <input type="date" id="rcaStartDate" value="2025-05-01"> - <input type="date" id="rcaEndDate" value="2025-07-26">
                </div>
            </div>

            <div class="rca-metrics-grid ecc-metrics-grid"> <!-- Reusing ecc-metrics-grid -->
                <div class="metric-card">
                    <h4>7 Days Obs</h4>
                    <div class="value" id="rca7DaysObs">0 <span class="trend down">▼ 100.0%</span></div>
                </div>
                <div class="metric-card">
                    <h4>Past 7 Days Obs</h4>
                    <div class="value" id="rcaPast7DaysObs">4 <span class="trend up">▲ 100.0%</span></div>
                </div>
                <div class="metric-card orange">
                    <h4>Critical Observations</h4>
                    <div class="value" id="rcaCriticalObs">0 <span class="trend down">▼ 100.0%</span></div>
                    <p>Last month: 6 <span class="trend up">▲ 100.0%</span></p>
                </div>
                <div class="metric-card">
                    <h4>Resolutions & Closures</h4>
                    <div class="value" id="rcaResolutionRate">28% <span class="trend flat">N/A</span></div>
                    <p>R Days = 8 <span class="trend flat">N/A</span></p>
                </div>
            </div>

            <div class="rca-charts-grid ecc-charts-grid">
                <div class="ecc-chart-card">
                    <h4>Causes Distribution</h4>
                    <div style="width: 100%; max-height: 300px;">
                        <canvas id="topFiveCausesChart"></canvas>
                    </div>
                </div>
                <div class="ecc-chart-card">
                    <h4>Obs Count - Six Month Trend</h4>
                    <div style="width: 100%; max-height: 300px;">
                        <canvas id="obsCountSixMonthTrendChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="rca-charts-grid ecc-charts-grid">
                <div class="ecc-chart-card">
                    <h4>Top Causes Index - Top Trends (MoM)</h4>
                    <div style="width: 100%; max-height: 300px;">
                        <canvas id="topCausesIndexTrendChart"></canvas>
                    </div>
                </div>
                <div class="ecc-chart-card">
                    <h4>Root Cause Intelligence - % Trend (Active)</h4>
                    <div class="rca-table-container zone-risk-table-container"> <!-- Reusing table container style -->
                        <table class="rca-table zone-risk-table" id="rcaActiveTrendTable">
                            <thead>
                                <tr>
                                    <th>RootCauseCategory</th>
                                    <th>1</th>
                                    <th>2</th>
                                    <th>4</th>
                                    <th>5</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Dynamic content will go here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="rca-charts-grid ecc-charts-grid">
                <div class="ecc-chart-card" style="grid-column: span 2;">
                    <h4>Root Cause Intelligence - % Trend (MoM)</h4>
                    <div class="rca-table-container zone-risk-table-container"> <!-- Reusing table container style -->
                        <table class="rca-table zone-risk-table" id="rcaMomTrendTable">
                            <thead>
                                <tr>
                                    <th>RootCauseCategory</th>
                                    <th>July</th>
                                    <th>June</th>
                                    <th>May</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Dynamic content will go here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    </div>

</div>

<script>
    let allProcessedData = []; // Global variable to store all processed data
    let zoneSeverityChartInstance = null; // Global variable to hold the Chart.js instance
    let openOverdueTrendChartInstance = null; // Global variable for the new chart
    let observationsAverageAgeChartInstance = null; // Global variable for the new chart

    // New Chart Instances for RCA tab
    let topFiveCausesChartInstance = null;
    let obsCountSixMonthTrendChartInstance = null;
    let topCausesIndexTrendChartInstance = null;


    document.addEventListener('DOMContentLoaded', () => {
        const headers = [
            'Sr#', 'ObservationCategory', 'ObservationID', 'Observer', 'ObserverID', 'ObserverPosition',
            'ObervationDateAndTime', 'Description', 'ImmediateCause', 'Zone', 'Location',
            'Department', 'InitialRiskImpression', 'ImmediateAction', 'Responsible',
            'IsReportedAsNearMiss', 'DueDate', 'Status', 'CloseDate', 'RootCauseCategory'
        ];
        // Define column indices for different date types
        const observationDateTimeColIndex = 6;
        const dueDateColIndex = 16;
        const closeDateColIndex = 18;
        const observationCategoryColIndex = 1; // Index for ObservationCategory
        const zoneColIndex = 9; // Index for Zone
        const statusColIndex = 17; // Index for Status
        const riskImpressionColIndex = 12; // Index for InitialRiskImpression
        const rootCauseCategoryColIndex = 19; // Index for RootCauseCategory

        // Severity mapping
        const severityMap = {
            "Low Concern": 1,
            "Moderate Concern": 2,
            "High Concern": 3,
            "Extreme Concern": 4,
            "Significant Concern": 5 // Added this based on image, assuming it maps to a 5th level
        };

        // Reverse map for severity (for active trend table)
        const reverseSeverityMap = {
            1: "Low Concern",
            2: "Moderate Concern",
            3: "High Concern",
            4: "Extreme Concern", // Assuming 4 maps to Extreme Concern
            5: "Significant Concern"
        };
        // Define the specific numerical risk levels to be displayed as columns for the active trend table
        const activeTrendRiskLevels = [1, 2, 4, 5]; // Based on the image's column headers

        // Define colors for each severity level for the chart
        const severityColors = {
            "Low Concern": '#2ecc71',    // Green
            "Moderate Concern": '#f1c40f', // Yellow
            "High Concern": '#3498db',   // Blue
            "Extreme Concern": '#e74c3c', // Red
            "Significant Concern": '#9b59b6' // Purple (for the 5th level if used)
        };

        // Get the data status element
        const dataStatusElement = document.getElementById('dataStatus');
        const reportPeriodStartSpan = document.getElementById('reportPeriodStart');
        const reportPeriodEndSpan = document.getElementById('reportPeriodEnd');
        const homeTabLink = document.querySelector('.tab-link[data-tab="home"]');
        const dataInputTabLink = document.querySelector('.tab-link[data-tab="data-input"]'); 
        const executiveCommandTabLink = document.querySelector('.tab-link[data-tab="executive-command"]'); 
        const rootCauseAnalysisTabLink = document.querySelector('.tab-link[data-tab="root-cause-analysis"]'); // New RCA tab link
        const tabLinks = document.querySelectorAll('.tab-link');
        const tabContents = document.querySelectorAll('.tab-content');

        // Executive Command Center elements
        const totalObservationsElem = document.getElementById('totalObservations');
        const totalGPElem = document.getElementById('totalGP');
        const openObservationsElem = document.getElementById('openObservations');
        const totalOverdueElem = document.getElementById('totalOverdue');
        const openOverdueElem = document.getElementById('openOverdue');
        const zoneRiskTableBody = document.getElementById('zoneRiskTable').querySelector('tbody');
        const criticalObsTableBody = document.getElementById('criticalObsTable').querySelector('tbody');
        const eccStartDateInput = document.getElementById('eccStartDate');
        const eccEndDateInput = document.getElementById('eccEndDate');
        const activeRiskGauge = document.getElementById('activeRiskGauge');
        const gaugeValueDisplay = activeRiskGauge.querySelector('.gauge-value-display');
        const gaugeNeedle = activeRiskGauge.querySelector('.gauge-needle');
        const gaugeArc = activeRiskGauge.querySelector('.gauge-arc');
        const zoneSeverityChartCanvas = document.getElementById('zoneSeverityChart');
        const openOverdueTrendChartCanvas = document.getElementById('openOverdueTrendChart');
        const observationsAverageAgeChartCanvas = document.getElementById('observationsAverageAgeChart');

        // Root Cause Analysis elements
        const rca7DaysObsElem = document.getElementById('rca7DaysObs');
        const rcaPast7DaysObsElem = document.getElementById('rcaPast7DaysObs');
        const rcaCriticalObsElem = document.getElementById('rcaCriticalObs');
        const rcaResolutionRateElem = document.getElementById('rcaResolutionRate');
        const rcaStartDateInput = document.getElementById('rcaStartDate');
        const rcaEndDateInput = document.getElementById('rcaEndDate');
        const topFiveCausesChartCanvas = document.getElementById('topFiveCausesChart');
        const obsCountSixMonthTrendChartCanvas = document.getElementById('obsCountSixMonthTrendChart');
        const topCausesIndexTrendChartCanvas = document.getElementById('topCausesIndexTrendChart');
        const rcaActiveTrendTableBody = document.getElementById('rcaActiveTrendTable').querySelector('tbody');
        const rcaMomTrendTableBody = document.getElementById('rcaMomTrendTable').querySelector('tbody');

        // --- File Processing Functionality ---
        const fileInput = document.getElementById('fileInput');
        const processBtn = document.getElementById('processBtn');
        const dataTable = document.getElementById('dataTable');
        const statusMessage = document.getElementById('statusMessage');
        const clearBtn = document.getElementById('clearBtn'); 
        const addRowBtn = document.getElementById('addRowBtn'); 
        const exportBtn = document.getElementById('exportBtn'); 
        const generatePdfBtn = document.getElementById('generatePdfBtn'); // Get the new PDF button
        const fileNameDisplay = document.getElementById('fileNameDisplay'); 


        // Function to set data status (verified/unverified)
        const setDataStatus = (isVerified) => {
            if (isVerified) {
                dataStatusElement.className = 'data-status verified';
                dataStatusElement.innerHTML = '<i class="fas fa-check-circle"></i> Data Verified';
                generatePdfBtn.disabled = false; // Enable PDF button
            } else {
                dataStatusElement.className = 'data-status unverified';
                dataStatusElement.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Data Unverified';
                generatePdfBtn.disabled = true; // Disable PDF button
            }
        };

        // Function to enable/disable tabs
        const setTabsEnabled = (enabled) => {
            tabLinks.forEach(link => {
                if (link.dataset.tab === 'data-input') {
                    link.classList.remove('disabled-tab'); // Data Input is always enabled
                } else if (enabled) {
                    link.classList.remove('disabled-tab');
                } else {
                    link.classList.add('disabled-tab');
                }
            });
        };

        // Initialize status to unverified and disable tabs on load
        setDataStatus(false);
        setTabsEnabled(false); // Disable all tabs except Data Input

        // Ensure Data Input tab is active and its content is shown on load
        tabLinks.forEach(link => link.classList.remove('active')); // Remove active from all tab links
        tabContents.forEach(content => content.classList.remove('active')); // Hide all tab contents
        dataInputTabLink.classList.add('active'); // Activate Data Input tab link
        document.getElementById('data-input-tab').classList.add('active'); // Show Data Input tab content


        // Helper function to format Date object to YYYY-MM-DD
        const formatDateForDateInput = (date) => {
            if (!(date instanceof Date) || isNaN(date)) return '';
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        // Helper function to format Date object to YYYY-MM-DDTHH:MM
        const formatDateTimeForDateTimeLocalInput = (date) => {
            if (!(date instanceof Date) || isNaN(date)) return '';
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        };

        // Helper function to parse date from various formats (Excel number, string, Date object)
        const parseDate = (dateValue) => {
            let dateObj;
            if (dateValue instanceof Date && !isNaN(dateValue)) {
                dateObj = dateValue;
            } else if (typeof dateValue === 'string') {
                dateObj = new Date(dateValue);
            } else if (typeof dateValue === 'number') {
                // XLSX.SSF.parse_date_code returns an object with y, m, d, H, M, S
                const parsedDate = XLSX.SSF.parse_date_code(dateValue);
                if (parsedDate && !isNaN(parsedDate.y) && !isNaN(parsedDate.m) && !isNaN(parsedDate.d)) {
                    dateObj = new Date(parsedDate.y, parsedDate.m - 1, parsedDate.d, parsedDate.H || 0, parsedDate.M || 0, parsedDate.S || 0);
                }
            }
            return dateObj && !isNaN(dateObj.getTime()) ? dateObj : null;
        };

        // --- Template Download Functionality ---
        const downloadTemplate = (type) => {
            const worksheet = XLSX.utils.aoa_to_sheet([headers]);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "HSE Observations");

            if (type === 'excel') {
                XLSX.writeFile(workbook, "HSE_Observations_Template.xlsx");
            } else if (type === 'csv') {
                const csvContent = headers.join(',') + '\n';
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.setAttribute('href', url);
                link.setAttribute('download', 'HSE_Observations_Template.csv');
                link.click();
            }
        };
        document.getElementById('downloadExcel').addEventListener('click', (e) => {
            e.preventDefault();
            downloadTemplate('excel');
        });
        document.getElementById('downloadCSV').addEventListener('click', (e) => {
            e.preventDefault();
            downloadTemplate('csv');
        });

        // Display selected file name
        fileInput.addEventListener('change', () => {
            if (fileInput.files.length > 0) {
                fileNameDisplay.textContent = `Selected file: ${fileInput.files[0].name}`;
                setDataStatus(false); // Reset status when a new file is chosen
                setTabsEnabled(false); // Re-disable tabs
                // Ensure Data Input tab is active and its content is shown
                tabLinks.forEach(link => link.classList.remove('active'));
                tabContents.forEach(content => content.classList.remove('active'));
                dataInputTabLink.classList.add('active');
                document.getElementById('data-input-tab').classList.add('active');
            } else {
                fileNameDisplay.textContent = 'No file chosen';
                setDataStatus(false); // Reset status if no file is chosen
                setTabsEnabled(false); // Re-disable tabs
                // Ensure Data Input tab is active and its content is shown
                tabLinks.forEach(link => link.classList.remove('active'));
                tabContents.forEach(content => content.classList.remove('active'));
                dataInputTabLink.classList.add('active');
                document.getElementById('data-input-tab').classList.add('active');
            }
        });

        processBtn.addEventListener('click', () => {
            const file = fileInput.files[0];
            if (!file) {
                statusMessage.textContent = 'Please select a file first.';
                statusMessage.className = 'error'; 
                setDataStatus(false); // Ensure status is unverified on error
                setTabsEnabled(false); // Keep tabs disabled
                dataInputTabLink.click(); // Stay on Data Input tab
                return;
            }
            statusMessage.textContent = '';
            statusMessage.className = ''; 

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array', cellDates: true }); 
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: "" }); 

                    allProcessedData = jsonData.slice(1); // Store all data rows globally, excluding header
                    displayData(jsonData); // Display all data in the input table

                    setDataStatus(true); // Set to verified on successful display
                    setTabsEnabled(true); // Enable all tabs
                    homeTabLink.click(); // Automatically go to Home tab
                    updateReportingPeriodFromData(jsonData); // Update reporting period

                    // Set default dates in ECC to the min/max dates from the data
                    const minMaxDates = getMinMaxObservationDates(allProcessedData);
                    if (minMaxDates.min) {
                        eccStartDateInput.value = formatDateForDateInput(minMaxDates.min);
                        rcaStartDateInput.value = formatDateForDateInput(minMaxDates.min); // Set RCA start date
                    }
                    if (minMaxDates.max) {
                        eccEndDateInput.value = formatDateForDateInput(minMaxDates.max);
                        rcaEndDateInput.value = formatDateForDateInput(minMaxDates.max); // Set RCA end date
                    }
                    // Update ECC and RCA with all data initially
                    updateExecutiveCommandCenter(allProcessedData); 
                    updateRootCauseAnalysis(allProcessedData); // Update RCA tab
                } catch (error) {
                    statusMessage.textContent = `Error processing file: ${error.message}`;
                    statusMessage.className = 'error';
                    setDataStatus(false); // Set to unverified on processing error
                    setTabsEnabled(false); // Keep tabs disabled
                    dataInputTabLink.click(); // Stay on Data Input tab
                }
            };
            reader.onerror = (error) => {
                statusMessage.textContent = `Error reading file: ${error.message}`;
                statusMessage.className = 'error';
                setDataStatus(false); // Set to unverified on read error
                setTabsEnabled(false); // Keep tabs disabled
                dataInputTabLink.click(); // Stay on Data Input tab
            };
            reader.readAsArrayBuffer(file);
        });

        // Event listener for the Clear Data button
        clearBtn.addEventListener('click', () => {
            const tableHead = dataTable.querySelector('thead tr');
            const tableBody = dataTable.querySelector('tbody');
            tableHead.innerHTML = ''; 
            tableBody.innerHTML = '<tr><td colspan="20">Your data will appear here after processing or manual entry.</td></tr>'; 
            statusMessage.textContent = ''; 
            statusMessage.className = ''; 
            fileInput.value = ''; 
            fileNameDisplay.textContent = 'No file chosen'; 
            setDataStatus(false); // Set to unverified when data is cleared
            setTabsEnabled(false); // Disable tabs again
            dataInputTabLink.click(); // Go back to Data Input tab
            // Reset reporting period display
            reportPeriodStartSpan.textContent = '--';
            reportPeriodEndSpan.textContent = '--';
            // Clear ECC metrics
            totalObservationsElem.innerHTML = `0 <span class="trend"><i class="fas fa-caret-up up"></i> N/A</span>`;
            totalGPElem.innerHTML = `0 <span class="trend"><i class="fas fa-caret-up up"></i> N/A</span>`;
            openObservationsElem.innerHTML = `0 <span class="trend"><i class="fas fa-caret-up up"></i> N/A</span>`;
            totalOverdueElem.innerHTML = `0 <span class="trend"><i class="fas fa-caret-up up"></i> N/A</span>`;
            openOverdueElem.innerHTML = `0 <span class="trend"><i class="fas fa-caret-up up"></i> N/A</span>`;
            zoneRiskTableBody.innerHTML = '<tr><td colspan="2">No data for selected period.</td></tr>'; // Clear zone risk table
            criticalObsTableBody.innerHTML = '<tr><td colspan="17">No data for selected period.</td></tr>'; // Clear critical obs table
            // Reset gauge
            gaugeValueDisplay.textContent = '0.00';
            gaugeNeedle.style.transform = 'translateX(-50%) rotate(0deg)';
            gaugeArc.style.backgroundColor = `#bdc3c7`; // Reset to default gray
            // Destroy chart instances
            if (zoneSeverityChartInstance) {
                zoneSeverityChartInstance.destroy();
                zoneSeverityChartInstance = null;
            }
            if (openOverdueTrendChartInstance) {
                openOverdueTrendChartInstance.destroy();
                openOverdueTrendChartInstance = null;
            }
            if (observationsAverageAgeChartInstance) {
                observationsAverageAgeChartInstance.destroy();
                observationsAverageAgeChartInstance = null;
            }
            // Clear RCA metrics
            rca7DaysObsElem.innerHTML = `0 <span class="trend down">▼ 100.0%</span>`;
            rcaPast7DaysObsElem.innerHTML = `0 <span class="trend up">▲ 100.0%</span>`;
            rcaCriticalObsElem.innerHTML = `0 <span class="trend down">▼ 100.0%</span>`;
            rcaCriticalObsElem.nextElementSibling.innerHTML = `Last month: 0 <span class="trend up">▲ 100.0%</span>`;
            rcaResolutionRateElem.innerHTML = `0% <span class="trend flat">N/A</span>`;
            rcaResolutionRateElem.nextElementSibling.innerHTML = `R Days = N/A <span class="trend flat">N/A</span>`;


            // Destroy RCA chart instances
            if (topFiveCausesChartInstance) {
                topFiveCausesChartInstance.destroy();
                topFiveCausesChartInstance = null;
            }
            if (obsCountSixMonthTrendChartInstance) {
                obsCountSixMonthTrendChartInstance.destroy();
                obsCountSixMonthTrendChartInstance = null;
            }
            if (topCausesIndexTrendChartInstance) {
                topCausesIndexTrendChartInstance.destroy();
                topCausesIndexTrendChartInstance = null;
            }
            // Clear RCA tables
            rcaActiveTrendTableBody.innerHTML = '<tr><td colspan="5">No data for selected period.</td></tr>';
            rcaMomTrendTableBody.innerHTML = '<tr><td colspan="4">No data for selected period.</td></tr>';

            // Reset ECC and RCA date inputs
            eccStartDateInput.value = '';
            eccEndDateInput.value = '';
            rcaStartDateInput.value = '';
            rcaEndDateInput.value = '';
            allProcessedData = []; // Clear global data
        });

        // Event listener for the Add New Row button
        addRowBtn.addEventListener('click', () => {
            const tableBody = dataTable.querySelector('tbody');
            // If the initial placeholder row exists, remove it
            if (tableBody.children.length === 1 && tableBody.children[0].firstElementChild.colSpan === 20) {
                tableBody.innerHTML = ''; 
            }
            
            // Ensure headers are present if adding the first row manually
            const tableHead = dataTable.querySelector('thead tr');
            if (tableHead.children.length === 0) {
                headers.forEach(headerText => {
                    const th = document.createElement('th');
                    th.textContent = headerText;
                    tableHead.appendChild(th);
                });
            }

            const newRow = document.createElement('tr');
            for (let i = 0; i < headers.length; i++) {
                const td = document.createElement('td');
                if (i === observationDateTimeColIndex) {
                    const input = document.createElement('input');
                    input.type = 'datetime-local';
                    td.appendChild(input);
                } else if (i === dueDateColIndex || i === closeDateColIndex) {
                    const input = document.createElement('input');
                    input.type = 'date';
                    td.appendChild(input);
                } else {
                    td.setAttribute('contenteditable', 'true'); 
                    td.textContent = ''; 
                }
                newRow.appendChild(td);
            }
            tableBody.appendChild(newRow);
            statusMessage.textContent = 'A new blank row has been added for manual entry.';
            statusMessage.className = 'success'; 
            setDataStatus(false); // Adding new data means it's unverified until processed/exported
            setTabsEnabled(false); // Keep tabs disabled
        });

        // Event listener for the Export Data button
        exportBtn.addEventListener('click', () => {
            const tableBody = dataTable.querySelector('tbody');
            if (tableBody.children.length === 0 || (tableBody.children.length === 1 && tableBody.children[0].firstElementChild.colSpan === 20)) {
                statusMessage.textContent = 'No data to export.';
                statusMessage.className = 'warning'; 
                setDataStatus(false); // Still unverified if no data
                return;
            }

            const exportData = [headers]; 

            // Iterate through table rows to extract data
            Array.from(tableBody.children).forEach(row => {
                const rowValues = [];
                Array.from(row.children).forEach((cell, colIndex) => {
                    if (cell.firstElementChild && (cell.firstElementChild.type === 'date' || cell.firstElementChild.type === 'datetime-local')) {
                        rowValues.push(cell.firstElementChild.value); 
                    } else {
                        rowValues.push(cell.textContent); 
                    }
                });
                exportData.push(rowValues);
            });

            const worksheet = XLSX.utils.aoa_to_sheet(exportData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "HSE Observations Export");
            XLSX.writeFile(workbook, "HSE_Observations_Export.xlsx");

            statusMessage.textContent = 'Data exported successfully as Excel.';
            statusMessage.className = 'success'; 
            setDataStatus(true); // Exporting implies data is verified for export
            setTabsEnabled(true); // Keep tabs enabled
        });

        // --- Generate PDF Functionality ---
        generatePdfBtn.addEventListener('click', async () => {
            statusMessage.textContent = 'Generating PDF... This may take a moment.';
            statusMessage.className = 'warning';
            generatePdfBtn.disabled = true; // Disable button during generation

            const { jsPDF } = window.jspdf;
            const content = document.querySelector('.container'); // Capture the entire container
            const allTabContents = document.querySelectorAll('.tab-content');
            const activeTabContent = document.querySelector('.tab-content.active');
            let originalDisplayStates = {};

            try {
                // Store original display states and make all tab contents visible
                allTabContents.forEach(tab => {
                    originalDisplayStates[tab.id] = tab.style.display;
                    tab.style.display = 'block';
                });

                // Re-render charts to ensure they are drawn correctly when made visible
                if (allProcessedData.length > 0) {
                    updateExecutiveCommandCenter(allProcessedData); // Re-render ECC charts
                    updateRootCauseAnalysis(allProcessedData); // Re-render RCA charts
                }

                const canvas = await html2canvas(content, {
                    scale: 2, // Increase scale for better resolution
                    useCORS: true // Enable CORS if you have external images/fonts
                });

                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF('p', 'mm', 'a4'); // 'p' for portrait, 'mm' for millimeters, 'a4' for A4 size
                const imgWidth = 210; // A4 width in mm
                const pageHeight = 297; // A4 height in mm
                const imgHeight = canvas.height * imgWidth / canvas.width;
                let heightLeft = imgHeight;

                let position = 0;

                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }

                pdf.save('Safety_Report.pdf');
                statusMessage.textContent = 'PDF generated successfully!';
                statusMessage.className = 'success';
            } catch (error) {
                console.error("Error generating PDF:", error);
                statusMessage.textContent = `Error generating PDF: ${error.message}`;
                statusMessage.className = 'error';
            } finally {
                generatePdfBtn.disabled = false; // Re-enable button after generation (or error)
                // Restore original display states
                allTabContents.forEach(tab => {
                    tab.style.display = originalDisplayStates[tab.id];
                });
                // Ensure the previously active tab is still active
                if (activeTabContent) {
                    activeTabContent.style.display = 'block';
                }
            }
        });


        const displayData = (data) => {
            const tableHead = dataTable.querySelector('thead tr');
            const tableBody = dataTable.querySelector('tbody');

            // Clear previous data
            tableHead.innerHTML = '';
            tableBody.innerHTML = '';

            if (data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="20">No data found in the file.</td></tr>';
                statusMessage.textContent = 'No data found in the file.';
                statusMessage.className = 'warning';
                setDataStatus(false); // No data, so unverified
                return;
            }

            // Populate table headers
            const headerRow = data[0];
            headerRow.forEach(headerText => {
                    const th = document.createElement('th');
                    th.textContent = headerText;
                    tableHead.appendChild(th);
            });

            // Populate table body with the rest of the data
            for (let i = 1; i < data.length; i++) {
                const rowData = data[i];
                const tr = document.createElement('tr');
                rowData.forEach((cellData, colIndex) => {
                    const td = document.createElement('td');
                    let displayValue = cellData; 

                    if (colIndex === observationDateTimeColIndex) {
                        const input = document.createElement('input');
                        input.type = 'datetime-local';
                        let dateObj = parseDate(cellData); // Use parseDate helper
                        if (dateObj) {
                            input.value = formatDateTimeForDateTimeLocalInput(dateObj);
                        }
                        td.appendChild(input);
                    } else if (colIndex === dueDateColIndex || colIndex === closeDateColIndex) {
                        const input = document.createElement('input');
                        input.type = 'date';
                        let dateObj = parseDate(cellData); // Use parseDate helper
                        if (dateObj) {
                            input.value = formatDateForDateInput(dateObj);
                        }
                        td.appendChild(input);
                    } else {
                        td.setAttribute('contenteditable', 'true'); 
                        td.textContent = displayValue;
                    }
                    tr.appendChild(td);
                });
                tableBody.appendChild(tr);
            }

            // Handle the case where the data rows are not as wide as the headers
            if (data.length > 1 && data[1].length < headerRow.length) {
                statusMessage.textContent = 'Warning: Some rows may have missing columns.';
                statusMessage.className = 'warning'; 
                setDataStatus(false); // Warning, so unverified
            } else {
                statusMessage.textContent = 'Data processed successfully.';
                statusMessage.className = 'success'; 
                setDataStatus(true); // Success, so verified
            }
        };

        // --- Tab Switching Logic ---
        tabLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const targetTab = e.target.dataset.tab;

                // Only switch if the tab is not disabled
                if (!e.target.classList.contains('disabled-tab')) {
                    // Deactivate all tabs and hide all content
                    tabLinks.forEach(l => l.classList.remove('active'));
                    tabContents.forEach(c => c.classList.remove('active'));

                    // Activate the clicked tab and show its content
                    e.target.classList.add('active');
                    document.getElementById(`${targetTab}-tab`).classList.add('active');

                    // If switching to ECC, update its content based on current date filters
                    if (targetTab === 'executive-command' && allProcessedData.length > 0) {
                        updateExecutiveCommandCenter(allProcessedData); // Pass all data
                    }
                    // If switching to RCA, update its content based on current date filters
                    if (targetTab === 'root-cause-analysis' && allProcessedData.length > 0) {
                        updateRootCauseAnalysis(allProcessedData); // Pass all data
                    }
                }
            });
        });

        // --- Dynamic Reporting Period for Home Tab ---
        const getMinMaxObservationDates = (data) => {
            let minDate = null;
            let maxDate = null;

            data.forEach(row => {
                const dateValue = row[observationDateTimeColIndex];
                const dateObj = parseDate(dateValue);

                if (dateObj) {
                    if (minDate === null || dateObj < minDate) {
                        minDate = dateObj;
                    }
                    if (maxDate === null || dateObj > maxDate) {
                        maxDate = dateObj;
                    }
                }
            });
            return { min: minDate, max: maxDate };
        };

        const updateReportingPeriodFromData = (jsonData) => {
            const { min, max } = getMinMaxObservationDates(jsonData.slice(1)); // Pass only data rows

            if (min && max) {
                reportPeriodStartSpan.textContent = min.toLocaleString('en-US', { month: 'short', year: '2-digit' });
                reportPeriodEndSpan.textContent = max.toLocaleString('en-US', { month: 'short', year: '2-digit' });
            } else {
                reportPeriodEndSpan.textContent = '--';
                reportPeriodEndSpan.textContent = '--';
            }
        };

        // Helper function to calculate trends
        const calculateTrend = (currentValue, previousValue) => {
            if (previousValue === 0) {
                if (currentValue === 0) return { trend: 'flat', percentage: '0.0' };
                return { trend: 'up', percentage: '100.0' }; // Infinite increase from zero
            }
            const percentage = ((currentValue - previousValue) / previousValue * 100).toFixed(1);
            const trend = percentage < 0 ? 'down' : (percentage > 0 ? 'up' : 'flat');
            return { trend, percentage: Math.abs(parseFloat(percentage)) };
        };

        // Helper function to calculate metrics for a given period
        const calculateMetricsForPeriod = (data, periodStartDate, periodEndDate, today) => {
            let totalObservations = 0;
            let totalGP = 0;
            let openObservations = 0;
            let totalOverdue = 0;
            let openOverdue = 0;

            data.forEach(row => {
                const observationDate = parseDate(row[observationDateTimeColIndex]);
                if (!observationDate || observationDate < periodStartDate || observationDate > periodEndDate) {
                    return; // Skip observations outside the current period
                }

                totalObservations++; // This counts observations within the specified period

                const observationCategory = row[observationCategoryColIndex];
                const status = typeof row[statusColIndex] === 'string' ? row[statusColIndex].toLowerCase() : '';
                const dueDateValue = row[dueDateColIndex];
                const closeDateValue = row[closeDateColIndex];

                if (observationCategory === 'Good Practice') {
                    totalGP++;
                }

                if (status === 'open' || status === 'in progress') {
                    openObservations++;
                }

                const dueDate = parseDate(dueDateValue);
                const closeDate = parseDate(closeDateValue);

                let normalizedDueDate = null;
                if (dueDate) {
                    normalizedDueDate = new Date(dueDate);
                    normalizedDueDate.setHours(0, 0, 0, 0);
                }

                let normalizedCloseDate = null;
                if (closeDate) {
                    normalizedCloseDate = new Date(closeDate);
                    normalizedCloseDate.setHours(0, 0, 0, 0);
                }

                if (normalizedDueDate && normalizedDueDate < today) {
                    if (status === 'open' || status === 'in progress') {
                        totalOverdue++;
                    } else if (status === 'closed' && normalizedCloseDate && normalizedCloseDate > normalizedDueDate) {
                        totalOverdue++;
                    }
                }

                if ((status === 'open' || status === 'in progress') && normalizedDueDate && normalizedDueDate < today) {
                    openOverdue++;
                }
            });

            return {
                totalObservations,
                totalGP,
                openObservations,
                totalOverdue,
                openOverdue
            };
        };


        // --- Update ECC content based on filtered data ---
        const updateExecutiveCommandCenter = (allData) => {
            if (allData.length === 0) {
                totalObservationsElem.innerHTML = `0 <span class="trend"><i class="fas fa-caret-up up"></i> N/A</span>`;
                totalGPElem.innerHTML = `0 <span class="trend"><i class="fas fa-caret-up up"></i> N/A</span>`;
                openObservationsElem.innerHTML = `0 <span class="trend"><i class="fas fa-caret-up up"></i> N/A</span>`;
                totalOverdueElem.innerHTML = `0 <span class="trend"><i class="fas fa-caret-up up"></i> N/A</span>`;
                openOverdueElem.innerHTML = `0 <span class="trend"><i class="fas fa-caret-up up"></i> N/A</span>`;
                zoneRiskTableBody.innerHTML = '<tr><td colspan="2">No data for selected period.</td></tr>';
                criticalObsTableBody.innerHTML = '<tr><td colspan="17">No data for selected period.</td></tr>';
                
                // Reset gauge
                gaugeValueDisplay.textContent = '0.00';
                gaugeNeedle.style.transform = 'translateX(-50%) rotate(0deg)';
                gaugeArc.style.backgroundColor = `#bdc3c7`; // Reset to default gray
                // Destroy chart instances
                if (zoneSeverityChartInstance) {
                    zoneSeverityChartInstance.destroy();
                    zoneSeverityChartInstance = null;
                }
                if (openOverdueTrendChartInstance) {
                    openOverdueTrendChartInstance.destroy();
                    openOverdueTrendChartInstance = null;
                }
                if (observationsAverageAgeChartInstance) {
                    observationsAverageAgeChartInstance.destroy();
                    observationsAverageAgeChartInstance = null;
                }
                return;
            }

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const currentStartDate = new Date(eccStartDateInput.value);
            currentStartDate.setHours(0, 0, 0, 0);
            const currentEndDate = new Date(eccEndDateInput.value);
            currentEndDate.setHours(23, 59, 59, 999);

            const currentPeriodMetrics = calculateMetricsForPeriod(allData, currentStartDate, currentEndDate, today);

            // Calculate previous period dates
            const durationMs = currentEndDate.getTime() - currentStartDate.getTime();
            const prevEndDate = new Date(currentStartDate.getTime() - (24 * 60 * 60 * 1000)); // One day before current start
            const prevStartDate = new Date(prevEndDate.getTime() - durationMs);

            const previousPeriodMetrics = calculateMetricsForPeriod(allData, prevStartDate, prevEndDate, today);

            // --- Calculate Trends and Update Metric Cards ---
            const trends = {
                totalObservations: calculateTrend(currentPeriodMetrics.totalObservations, previousPeriodMetrics.totalObservations),
                totalGP: calculateTrend(currentPeriodMetrics.totalGP, previousPeriodMetrics.totalGP),
                openObservations: calculateTrend(currentPeriodMetrics.openObservations, previousPeriodMetrics.openObservations),
                totalOverdue: calculateTrend(currentPeriodMetrics.totalOverdue, previousPeriodMetrics.totalOverdue),
                openOverdue: calculateTrend(currentPeriodMetrics.openOverdue, previousPeriodMetrics.openOverdue)
            };

            totalObservationsElem.innerHTML = `${currentPeriodMetrics.totalObservations} <span class="trend ${trends.totalObservations.trend}"><i class="fas fa-caret-${trends.totalObservations.trend === 'up' ? 'up' : (trends.totalObservations.trend === 'down' ? 'down' : 'right')}"></i> ${trends.totalObservations.percentage}%</span>`;
            totalGPElem.innerHTML = `${currentPeriodMetrics.totalGP} <span class="trend ${trends.totalGP.trend}"><i class="fas fa-caret-${trends.totalGP.trend === 'up' ? 'up' : (trends.totalGP.trend === 'down' ? 'down' : 'right')}"></i> ${trends.totalGP.percentage}%</span>`;
            openObservationsElem.innerHTML = `${currentPeriodMetrics.openObservations} <span class="trend ${trends.openObservations.trend}"><i class="fas fa-caret-${trends.openObservations.trend === 'up' ? 'up' : (trends.openObservations.trend === 'down' ? 'down' : 'right')}"></i> ${trends.openObservations.percentage}%</span>`;
            totalOverdueElem.innerHTML = `${currentPeriodMetrics.totalOverdue} <span class="trend ${trends.totalOverdue.trend}"><i class="fas fa-caret-${trends.totalOverdue.trend === 'up' ? 'up' : (trends.totalOverdue.trend === 'down' ? 'down' : 'right')}"></i> ${trends.totalOverdue.percentage}%</span>`;
            openOverdueElem.innerHTML = `${currentPeriodMetrics.openOverdue} <span class="trend ${trends.openOverdue.trend}"><i class="fas fa-caret-${trends.openOverdue.trend === 'up' ? 'up' : (trends.openOverdue.trend === 'down' ? 'down' : 'right')}"></i> ${trends.openOverdue.percentage}%</span>`;


            // Filter data for charts and tables based on the current ECC date range
            const filteredDataForChartsAndTables = allData.filter(row => {
                const observationDate = parseDate(row[observationDateTimeColIndex]);
                return observationDate && observationDate >= currentStartDate && observationDate <= currentEndDate;
            });

            const zones = new Set();
            const criticalObsByZoneCategory = {}; // {zone: {category: count}}
            const openObservationsSeverityByZone = {}; // {zone: {totalSeverity: 0, count: 0}} for risk index
            const zoneSeverityCounts = {}; // {zone: {severityName: count}} for chart
            const openOverdueCountsByZone = {}; // {zone: {open: count, overdue: count}} for new chart
            const observationsAgeDataByZone = {}; // {zone: {totalDays: 0, count: 0, obsCount: 0}} for average age chart

            filteredDataForChartsAndTables.forEach(row => {
                const observationCategory = row[observationCategoryColIndex];
                const status = typeof row[statusColIndex] === 'string' ? row[statusColIndex].toLowerCase() : '';
                const dueDateValue = row[dueDateColIndex];
                const closeDateValue = row[closeDateColIndex];
                const zone = row[zoneColIndex];
                const riskImpression = row[riskImpressionColIndex];
                const observationDate = parseDate(row[observationDateTimeColIndex]);

                // Collect zones
                if (zone) {
                    zones.add(zone);
                }

                // Populate critical observations by zone and category
                if (zone && observationCategory) {
                    if (!criticalObsByZoneCategory[zone]) {
                        criticalObsByZoneCategory[zone] = {};
                    }
                    criticalObsByZoneCategory[zone][observationCategory] = (criticalObsByZoneCategory[zone][observationCategory] || 0) + 1;
                }

                // Calculate average open severity per zone for risk index
                if (zone && (status === 'open' || status === 'in progress') && riskImpression) {
                    const severityValue = severityMap[riskImpression];
                    if (severityValue) {
                        if (!openObservationsSeverityByZone[zone]) {
                            openObservationsSeverityByZone[zone] = { totalSeverity: 0, count: 0 };
                        }
                        openObservationsSeverityByZone[zone].totalSeverity += severityValue;
                        openObservationsSeverityByZone[zone].count++;
                    }

                    // For Zone OBS Severity Trends chart
                    if (!zoneSeverityCounts[zone]) {
                        zoneSeverityCounts[zone] = {};
                    }
                    zoneSeverityCounts[zone][riskImpression] = (zoneSeverityCounts[zone][riskImpression] || 0) + 1;
                }

                // For Open OBS & Overdue Trend Chart
                if (zone) {
                    if (!openOverdueCountsByZone[zone]) {
                        openOverdueCountsByZone[zone] = { open: 0, overdue: 0 };
                    }
                    if (status === 'open' || status === 'in progress') {
                        openOverdueCountsByZone[zone].open++;
                    }
                    const dueDate = parseDate(dueDateValue);
                    let normalizedDueDate = null;
                    if (dueDate) {
                        normalizedDueDate = new Date(dueDate);
                        normalizedDueDate.setHours(0, 0, 0, 0);
                    }
                    if ((status === 'open' || status === 'in progress') && normalizedDueDate && normalizedDueDate < today) {
                        openOverdueCountsByZone[zone].overdue++;
                    }
                }

                // For Observations Average Age (Days Before Close) Chart
                if (zone && observationDate && closeDateValue && (status === 'closed')) { // Only for closed observations
                    const closeDate = parseDate(closeDateValue);
                    const diffTime = Math.abs(closeDate.getTime() - observationDate.getTime());
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    if (!observationsAgeDataByZone[zone]) {
                        observationsAgeDataByZone[zone] = { totalDays: 0, count: 0, obsCount: 0 };
                    }
                    observationsAgeDataByZone[zone].totalDays += diffDays;
                    observationsAgeDataByZone[zone].count++;
                    observationsAgeDataByZone[zone].obsCount++;
                }
            });

            // --- Populate Zone Risk Index Table ---
            zoneRiskTableBody.innerHTML = '';
            const zoneRiskData = [];
            Array.from(zones).forEach(zone => {
                const zoneSeverityData = openObservationsSeverityByZone[zone];
                let riskIndex = 0;
                if (zoneSeverityData && zoneSeverityData.count > 0) {
                    riskIndex = (zoneSeverityData.totalSeverity / zoneSeverityData.count) * 5;
                }
                if (zoneSeverityData && zoneSeverityData.count > 0) {
                    zoneRiskData.push({ zone: zone, riskIndex: parseFloat(riskIndex.toFixed(2)) });
                }
            });

            zoneRiskData.sort((a, b) => b.riskIndex - a.riskIndex);

            zoneRiskData.forEach(({ zone, riskIndex }) => {
                const tr = document.createElement('tr');
                const tdZone = document.createElement('td');
                tdZone.textContent = zone;
                const tdRisk = document.createElement('td');
                tdRisk.textContent = riskIndex; 

                if (riskIndex <= 7.5) {
                    tdRisk.classList.add('risk-low');
                } else if (riskIndex <= 12.5) {
                    tdRisk.classList.add('risk-medium');
                } else {
                    tdRisk.classList.add('risk-high');
                }

                tr.appendChild(tdZone);
                tr.appendChild(tdRisk);
                zoneRiskTableBody.appendChild(tr);
            });

            if (zoneRiskData.length === 0) {
                zoneRiskTableBody.innerHTML = '<tr><td colspan="2">No zone data available for selected period or no open non-GP observations.</td></tr>';
            }

            // --- Calculate Active Organizational Risk Index ---
            let totalRiskIndexSum = 0;
            let zonesWithRisk = 0;
            zoneRiskData.forEach(item => {
                totalRiskIndexSum += item.riskIndex;
                zonesWithRisk++;
            });

            let activeOrganizationalRiskIndex = 0;
            if (zonesWithRisk > 0) {
                activeOrganizationalRiskIndex = (totalRiskIndexSum / zonesWithRisk).toFixed(2);
            }

            const maxGaugeValue = 25;
            let needleRotationDegrees = (parseFloat(activeOrganizationalRiskIndex) / maxGaugeValue) * 180;
            needleRotationDegrees = Math.min(180, Math.max(0, needleRotationDegrees));

            gaugeNeedle.style.transform = `translateX(-50%) rotate(${needleRotationDegrees}deg)`;
            gaugeValueDisplay.textContent = activeOrganizationalRiskIndex;

            if (activeOrganizationalRiskIndex <= 7.5) {
                gaugeArc.style.backgroundColor = '#2ecc71';
            } else if (activeOrganizationalRiskIndex <= 12.5) {
                gaugeArc.style.backgroundColor = '#f1c40f';
            } else {
                gaugeArc.style.backgroundColor = '#e74c3c';
            }

            // --- Populate REAL-TIME RISK - Active Critical OBS Table ---
            criticalObsTableBody.innerHTML = '';
            const fixedCriticalCategories = [
                'Fall Protection', 'Fire Safety', 'Good Practice', 'Housekeeping', 'Electrical Safety',
                'LOTO', 'Machine Guarding', 'Confined Space', 'First Aid', 'Hazard Communication',
                'Ergonomics', 'Emergency Preparedness', 'Traffic Safety', 'Noise Exposure', 'Welding/Cutting'
            ];

            const sortedZones = Array.from(zones).sort();

            sortedZones.forEach(zone => {
                const tr = document.createElement('tr');
                const tdZone = document.createElement('td');
                tdZone.textContent = zone;
                tr.appendChild(tdZone);

                let totalActiveInZone = 0;
                fixedCriticalCategories.forEach(category => {
                    const td = document.createElement('td');
                    const count = criticalObsByZoneCategory[zone] && criticalObsByZoneCategory[zone][category] ? criticalObsByZoneCategory[zone][category] : '';
                    td.textContent = count;
                    if (count > 0) {
                        td.classList.add('critical-cell');
                        totalActiveInZone += count;
                    }
                    tr.appendChild(td);
                });

                const tdTotalActive = document.createElement('td');
                tdTotalActive.textContent = totalActiveInZone > 0 ? totalActiveInZone : '';
                if (totalActiveInZone > 0) {
                    tdTotalActive.classList.add('critical-cell');
                }
                tr.appendChild(tdTotalActive);
                criticalObsTableBody.appendChild(tr);
            });

            if (sortedZones.length === 0) {
                criticalObsTableBody.innerHTML = '<tr><td colspan="17">No critical observation data available.</td></tr>';
            }
            
            // --- Zone OBS Severity Trends Chart ---
            renderZoneSeverityChart(zoneSeverityCounts, sortedZones);

            // --- Open OBS & Overdue Trend Chart ---
            renderOpenOverdueTrendChart(openOverdueCountsByZone, sortedZones);

            // --- Observations Average Age (Days Before Close) Chart ---
            renderObservationsAverageAgeChart(observationsAgeDataByZone, sortedZones);
        };

        // Add event listeners to ECC date inputs
        eccStartDateInput.addEventListener('change', () => updateExecutiveCommandCenter(allProcessedData));
        eccEndDateInput.addEventListener('change', () => updateExecutiveCommandCenter(allProcessedData));


        // --- Update Root Cause Analysis Metrics and Charts ---
        const updateRootCauseAnalysis = (allData) => {
            if (allData.length === 0) {
                rca7DaysObsElem.innerHTML = `0 <span class="trend down">▼ 100.0%</span>`;
                rcaPast7DaysObsElem.innerHTML = `0 <span class="trend up">▲ 100.0%</span>`;
                rcaCriticalObsElem.innerHTML = `0 <span class="trend down">▼ 100.0%</span>`;
                rcaCriticalObsElem.nextElementSibling.innerHTML = `Last month: 0 <span class="trend up">▲ 100.0%</span>`;
                rcaResolutionRateElem.innerHTML = `0% <span class="trend flat">N/A</span>`;
                rcaResolutionRateElem.nextElementSibling.innerHTML = `R Days = N/A <span class="trend flat">N/A</span>`;

                if (topFiveCausesChartInstance) {
                    topFiveCausesChartInstance.destroy();
                    topFiveCausesChartInstance = null;
                }
                if (obsCountSixMonthTrendChartInstance) {
                    obsCountSixMonthTrendChartInstance.destroy();
                    obsCountSixMonthTrendChartInstance = null;
                }
                if (topCausesIndexTrendChartInstance) {
                    topCausesIndexTrendChartInstance.destroy();
                    topCausesIndexTrendChartInstance = null;
                }
                rcaActiveTrendTableBody.innerHTML = '<tr><td colspan="5">No data for selected period.</td></tr>';
                rcaMomTrendTableBody.innerHTML = '<tr><td colspan="4">No data for selected period.</td></tr>';
                return;
            }

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const sevenDaysAgo = new Date(today);
            sevenDaysAgo.setDate(today.getDate() - 7);
            sevenDaysAgo.setHours(0, 0, 0, 0);

            const fourteenDaysAgo = new Date(today);
            fourteenDaysAgo.setDate(today.getDate() - 14);
            fourteenDaysAgo.setHours(0, 0, 0, 0);

            // RCA Date Picker Range for "Current Period"
            const rcaCurrentStartDate = new Date(rcaStartDateInput.value);
            rcaCurrentStartDate.setHours(0, 0, 0, 0);
            const rcaCurrentEndDate = new Date(rcaEndDateInput.value);
            rcaCurrentEndDate.setHours(23, 59, 59, 999);

            // Previous Month for Critical Observations
            const prevMonthRcaStartDate = new Date(rcaCurrentStartDate.getFullYear(), rcaCurrentStartDate.getMonth() - 1, 1);
            prevMonthRcaStartDate.setHours(0, 0, 0, 0);
            const prevMonthRcaEndDate = new Date(rcaCurrentStartDate.getFullYear(), rcaCurrentStartDate.getMonth(), 0);
            prevMonthRcaEndDate.setHours(23, 59, 59, 999);

            let obs7Days = 0;
            let obsPast7Days = 0;
            let criticalObsCurrent = 0;
            let criticalObsLastMonth = 0;
            let resolvedObs = 0;
            let totalClosures = 0;
            let totalResolutionDays = 0;

            const rootCauseCounts = {};
            const obsCountByMonth = {};
            const rcaActiveTrendCounts = {};
            const rcaMomTrendCounts = {};

            allData.forEach(row => { // Iterate over ALL data
                const observationDate = parseDate(row[observationDateTimeColIndex]);
                const status = typeof row[statusColIndex] === 'string' ? row[statusColIndex].toLowerCase() : '';
                const riskImpression = row[riskImpressionColIndex];
                const closeDate = parseDate(row[closeDateColIndex]);
                const rootCauseCategory = row[rootCauseCategoryColIndex];

                if (!observationDate) return; // Skip invalid dates

                // 7 Days Obs (relative to today)
                if (observationDate >= sevenDaysAgo && observationDate <= today) {
                    obs7Days++;
                }
                // Past 7 Days Obs (relative to today)
                if (observationDate >= fourteenDaysAgo && observationDate < sevenDaysAgo) {
                    obsPast7Days++;
                }

                // Critical Observations (Current Period based on RCA date picker)
                if (observationDate >= rcaCurrentStartDate && observationDate <= rcaCurrentEndDate) {
                    if ((status === 'open' || status === 'in progress') && (riskImpression === 'Extreme Concern' || riskImpression === 'High Concern' || riskImpression === 'Significant Concern')) {
                        criticalObsCurrent++;
                    }
                }

                // Critical Observations (Last Month relative to RCA date picker)
                if (observationDate >= prevMonthRcaStartDate && observationDate <= prevMonthRcaEndDate) {
                     if ((status === 'open' || status === 'in progress') && (riskImpression === 'Extreme Concern' || riskImpression === 'High Concern' || riskImpression === 'Significant Concern')) {
                        criticalObsLastMonth++;
                    }
                }

                // Resolutions & Closures (based on all data, but only closed observations)
                if (status === 'closed' && observationDate && closeDate) {
                    resolvedObs++;
                    totalClosures++;
                    const diffTime = Math.abs(closeDate.getTime() - observationDate.getTime());
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    totalResolutionDays += diffDays;
                }

                // Top Five Causes (based on all data within the RCA date range)
                if (observationDate >= rcaCurrentStartDate && observationDate <= rcaCurrentEndDate && rootCauseCategory) {
                    rootCauseCounts[rootCauseCategory] = (rootCauseCounts[rootCauseCategory] || 0) + 1;
                }

                // Obs Count - Six Month Trend (based on all data)
                const monthYear = observationDate.toLocaleString('en-US', { month: 'short', year: 'numeric' });
                obsCountByMonth[monthYear] = (obsCountByMonth[monthYear] || 0) + 1;

                // Root Cause Intelligence - % Trend (Active) Table Data (based on all data within RCA date range)
                if (observationDate >= rcaCurrentStartDate && observationDate <= rcaCurrentEndDate && (status === 'open' || status === 'in progress') && rootCauseCategory && riskImpression) {
                    const riskValue = severityMap[riskImpression];
                    if (activeTrendRiskLevels.includes(riskValue)) {
                        if (!rcaActiveTrendCounts[rootCauseCategory]) {
                            rcaActiveTrendCounts[rootCauseCategory] = {};
                            activeTrendRiskLevels.forEach(level => rcaActiveTrendCounts[rootCauseCategory][level] = 0);
                        }
                        rcaActiveTrendCounts[rootCauseCategory][riskValue]++;
                    }
                }

                // Root Cause Intelligence - % Trend (MoM) Table Data (based on all data within relevant months)
                if (rootCauseCategory && observationDate) {
                    const monthName = observationDate.toLocaleString('en-US', { month: 'short' });
                    if (!rcaMomTrendCounts[rootCauseCategory]) {
                        rcaMomTrendCounts[rootCauseCategory] = {};
                    }
                    rcaMomTrendCounts[rootCauseCategory][monthName] = (rcaMomTrendCounts[rootCauseCategory][monthName] || 0) + 1;
                }
            });

            // Update RCA Metrics
            const trend7Days = calculateTrend(obs7Days, obsPast7Days);
            const trendCritical = calculateTrend(criticalObsCurrent, criticalObsLastMonth);
            const resolutionRate = totalClosures > 0 ? ((resolvedObs / totalClosures) * 100).toFixed(1) : '0.0';
            const avgResolutionDays = resolvedObs > 0 ? (totalResolutionDays / resolvedObs).toFixed(1) : 'N/A';

            rca7DaysObsElem.innerHTML = `${obs7Days} <span class="trend ${trend7Days.trend}"><i class="fas fa-caret-${trend7Days.trend === 'up' ? 'up' : (trend7Days.trend === 'down' ? 'down' : 'right')}"></i> ${trend7Days.percentage}%</span>`;
            rcaPast7DaysObsElem.innerHTML = `${obsPast7Days} <span class="trend ${trend7Days.trend === 'up' ? 'down' : (trend7Days.trend === 'down' ? 'up' : 'flat')}"><i class="fas fa-caret-${trend7Days.trend === 'up' ? 'down' : (trend7Days.trend === 'down' ? 'up' : 'right')}"></i> ${trend7Days.percentage}%</span>`; 
            rcaCriticalObsElem.innerHTML = `${criticalObsCurrent} <span class="trend ${trendCritical.trend}"><i class="fas fa-caret-${trendCritical.trend === 'up' ? 'up' : (trendCritical.trend === 'down' ? 'down' : 'right')}"></i> ${trendCritical.percentage}%</span>`;
            rcaCriticalObsElem.nextElementSibling.innerHTML = `Last month: ${criticalObsLastMonth} <span class="trend ${trendCritical.trend === 'up' ? 'down' : (trendCritical.trend === 'down' ? 'up' : 'flat')}"><i class="fas fa-caret-${trendCritical.trend === 'up' ? 'down' : (trendCritical.trend === 'down' ? 'up' : 'right')}"></i> ${trendCritical.percentage}%</span>`; 
            rcaResolutionRateElem.innerHTML = `${resolutionRate}% <span class="trend flat">N/A</span>`; 
            rcaResolutionRateElem.nextElementSibling.innerHTML = `R Days = ${avgResolutionDays} <span class="trend flat">N/A</span>`; 


            // Render RCA Charts
            renderTopFiveCausesChart(rootCauseCounts);
            renderObsCountSixMonthTrendChart(obsCountByMonth);
            renderTopCausesIndexTrendChart(); // This chart will still use dummy data as its logic is complex and not fully defined by the image.

            // Populate Root Cause Intelligence - % Trend (Active) Table
            populateRcaActiveTrendTable(rcaActiveTrendCounts, activeTrendRiskLevels);

            // Populate Root Cause Intelligence - % Trend (MoM) Table
            populateRcaMomTrendTable(rcaMomTrendCounts, rcaEndDateInput);
        };

        // Add event listeners to RCA date inputs
        rcaStartDateInput.addEventListener('change', () => updateRootCauseAnalysis(allProcessedData));
        rcaEndDateInput.addEventListener('change', () => updateRootCauseAnalysis(allProcessedData));


        // --- Render Zone Severity Chart ---
        const renderZoneSeverityChart = (zoneSeverityData, sortedZones) => {
            if (zoneSeverityChartInstance) {
                zoneSeverityChartInstance.destroy(); // Destroy existing chart instance
            }

            const ctx = zoneSeverityChartCanvas.getContext('2d');
            
            const allSeverityLevels = Object.keys(severityColors); // Get all defined severity levels

            const datasets = allSeverityLevels.map(severity => {
                return {
                    label: severity,
                    data: sortedZones.map(zone => (zoneSeverityData[zone] && zoneSeverityData[zone][severity]) ? zoneSeverityData[zone][severity] : 0),
                    backgroundColor: severityColors[severity],
                    borderColor: severityColors[severity],
                    borderWidth: 1
                };
            });

            zoneSeverityChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedZones,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false, // Allow canvas to resize freely
                    plugins: {
                        title: {
                            display: true,
                            text: 'Open Observations by Zone and Severity',
                            font: {
                                size: 16,
                                weight: 'bold'
                            },
                            color: '#34495e'
                        },
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#333'
                            }
                        }
                    },
                    scales: {
                        x: {
                            stacked: false, // For clustered columns
                            title: {
                                display: true,
                                text: 'Zone',
                                color: '#333'
                            },
                            ticks: {
                                color: '#555'
                            }
                        },
                        y: {
                            stacked: false, // For clustered columns
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Open OBS Count',
                                color: '#333'
                            },
                            ticks: {
                                color: '#555',
                                precision: 0 // Ensure integer ticks for counts
                            }
                        }
                    }
                }
            });
        };

        // --- Render Open OBS & Overdue Trend Chart ---
        const renderOpenOverdueTrendChart = (openOverdueCountsByZone, sortedZones) => {
            if (openOverdueTrendChartInstance) {
                openOverdueTrendChartInstance.destroy(); // Destroy existing chart instance
            }

            const ctx = openOverdueTrendChartCanvas.getContext('2d');

            const openData = sortedZones.map(zone => (openOverdueCountsByZone[zone] && openOverdueCountsByZone[zone].open) ? openOverdueCountsByZone[zone].open : 0);
            const overdueData = sortedZones.map(zone => (openOverdueCountsByZone[zone] && openOverdueCountsByZone[zone].overdue) ? openOverdueCountsByZone[zone].overdue : 0);

            openOverdueTrendChartInstance = new Chart(ctx, {
                type: 'bar', // Default to bar type
                data: {
                    labels: sortedZones,
                    datasets: [
                        {
                            label: 'Open OBS Count',
                            data: openData,
                            backgroundColor: '#3498db', // Blue for open observations
                            borderColor: '#3498db',
                            borderWidth: 1,
                            yAxisID: 'y' // Primary Y-axis
                        },
                        {
                            label: 'Overdue Count',
                            data: overdueData,
                            type: 'line', // This dataset will be a line
                            borderColor: '#f39c12', // Orange for overdue observations
                            backgroundColor: 'rgba(243, 156, 18, 0.2)', // Light orange fill for line
                            fill: false,
                            tension: 0.3,
                            yAxisID: 'y1', // Secondary Y-axis
                            pointRadius: 5,
                            pointBackgroundColor: '#f39c12',
                            pointBorderColor: '#fff',
                            pointHoverRadius: 7
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Open OBS & Overdue Trend',
                            font: {
                                size: 16,
                                weight: 'bold'
                            },
                            color: '#34495e'
                        },
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#333'
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Zone',
                                color: '#333'
                            },
                            ticks: {
                                color: '#555'
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Open OBS Count',
                                color: '#333'
                            },
                            ticks: {
                                color: '#555',
                                precision: 0
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            beginAtZero: true,
                            grid: {
                                drawOnChartArea: false
                            },
                            title: {
                                display: true,
                                text: 'Overdue Count',
                                color: '#333'
                            },
                            ticks: {
                                color: '#555',
                                precision: 0
                            }
                        }
                    }
                }
            });
        };

        // --- Render Observations Average Age (Days Before Close) Chart ---
        const renderObservationsAverageAgeChart = (observationsAgeDataByZone, sortedZones) => {
            if (observationsAverageAgeChartInstance) {
                observationsAverageAgeChartInstance.destroy(); // Destroy existing chart instance
            }

            const ctx = observationsAverageAgeChartCanvas.getContext('2d');

            const obsCountData = sortedZones.map(zone => (observationsAgeDataByZone[zone] && observationsAgeDataByZone[zone].obsCount) ? observationsAgeDataByZone[zone].obsCount : 0); // Use obsCount for bars
            const averageAgeData = sortedZones.map(zone => (observationsAgeDataByZone[zone] && observationsAgeDataByZone[zone].count > 0) ? parseFloat((observationsAgeDataByZone[zone].totalDays / observationsAgeDataByZone[zone].count).toFixed(2)) : 0);

            observationsAverageAgeChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedZones,
                    datasets: [
                        {
                            label: 'OBS Count',
                            data: obsCountData,
                            backgroundColor: '#f39c12', // Orange for observation count
                            borderColor: '#f39c12',
                            borderWidth: 1,
                            yAxisID: 'y' // Primary Y-axis
                        },
                        {
                            label: 'Average Age (Days)',
                            data: averageAgeData,
                            type: 'line',
                            borderColor: '#3498db', // Blue for average age
                            backgroundColor: 'rgba(52, 152, 219, 0.2)',
                            fill: false,
                            tension: 0.3,
                            yAxisID: 'y1', // Secondary Y-axis
                            pointRadius: 5,
                            pointBackgroundColor: '#3498db',
                            pointBorderColor: '#fff',
                            pointHoverRadius: 7
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Observations Average Age (Days Before Close)',
                            font: {
                                size: 16,
                                weight: 'bold'
                            },
                            color: '#34495e'
                        },
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#333'
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Zone',
                                color: '#333'
                            },
                            ticks: {
                                color: '#555'
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'OBS Count',
                                color: '#333'
                            },
                            ticks: {
                                color: '#555',
                                precision: 0
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            beginAtZero: true,
                            grid: {
                                drawOnChartArea: false
                            },
                            title: {
                                display: true,
                                text: 'Average Days',
                                color: '#333'
                            },
                            ticks: {
                                color: '#555',
                                precision: 0
                            }
                        }
                    }
                }
            });
        };

        // --- Render Top Five Causes Chart (Pie Chart) ---
        const renderTopFiveCausesChart = (rootCauseCounts) => {
            if (topFiveCausesChartInstance) {
                topFiveCausesChartInstance.destroy();
            }

            const ctx = topFiveCausesChartCanvas.getContext('2d');
            const labels = Object.keys(rootCauseCounts);
            const data = Object.values(rootCauseCounts);

            // Generate some distinct colors for the pie chart segments
            const backgroundColors = [
                '#8e44ad', // Purple (Supervision & Leadership Failure)
                '#34495e', // Dark Blue (Equipment & Tool Related)
                '#2ecc71', // Green (Management System Deficiency)
                '#f1c40f', // Yellow (Training & Competency Gap)
                '#e67e22', // Orange (Work Environment/Conditions)
                '#3498db', // Blue (Fallback)
                '#e74c3c'  // Red (Fallback)
            ];

            topFiveCausesChartInstance = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: backgroundColors.slice(0, labels.length), // Use enough colors
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Causes Distribution', // Changed title here
                            font: {
                                size: 16,
                                weight: 'bold'
                            },
                            color: '#34495e'
                        },
                        legend: {
                            position: 'right', // Place legend on the right
                            labels: {
                                color: '#333',
                                boxWidth: 20, // Make color boxes slightly larger
                                padding: 15 // Add padding between legend items
                            }
                        }
                    }
                }
            });
        };

        // --- Render Obs Count - Six Month Trend Chart (Bar Chart) ---
        const renderObsCountSixMonthTrendChart = (obsCountByMonth) => {
            if (obsCountSixMonthTrendChartInstance) {
                obsCountSixMonthTrendChartInstance.destroy();
            }

            const ctx = obsCountSixMonthTrendChartCanvas.getContext('2d');
            
            // Sort months chronologically for display
            const sortedMonths = Object.keys(obsCountByMonth).sort((a, b) => {
                const dateA = new Date(a + ' 1, 2000'); // Use a dummy year for comparison
                const dateB = new Date(b + ' 1, 2000');
                return dateA - dateB;
            });

            const data = sortedMonths.map(month => obsCountByMonth[month]);

            obsCountSixMonthTrendChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedMonths,
                    datasets: [{
                        label: 'Observation Count',
                        data: data,
                        backgroundColor: '#3498db', // Blue bars
                        borderColor: '#2980b9',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Obs Count - Six Month Trend',
                            font: {
                                size: 16,
                                weight: 'bold'
                            },
                            color: '#34495e'
                        },
                        legend: {
                            display: false // No legend needed for single dataset
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Month',
                                color: '#333'
                            },
                            ticks: {
                                color: '#555'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Count',
                                color: '#333'
                            },
                            ticks: {
                                color: '#555',
                                precision: 0
                            }
                        }
                    }
                }
            });
        };

        // --- Render Top Causes Index - Top Trends (MoM) Chart (Dummy Data) ---
        const renderTopCausesIndexTrendChart = () => {
            if (topCausesIndexTrendChartInstance) {
                topCausesIndexTrendChartInstance.destroy();
            }

            const ctx = topCausesIndexTrendChartCanvas.getContext('2d');
            
            // Dummy data based on the image structure
            const labels = ['Equipment & Tool Related', 'Management System Deficiency', 'Supervision & Leadership Failure', 'Training & Competency Gap', 'Work Environment/Conditions'];
            const julyData = [1, 1, 3, 1, 1];
            const juneData = [1, 1, 1, 1, 2];
            const mayData = [4, 3, 1, 1, 1]; // Adjusted based on visual representation in image for May

            topCausesIndexTrendChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'July',
                            data: julyData,
                            backgroundColor: '#3498db', // Blue
                            borderColor: '#2980b9',
                            borderWidth: 1
                        },
                        {
                            label: 'June',
                            data: juneData,
                            backgroundColor: '#2ecc71', // Green
                            borderColor: '#27ae60',
                            borderWidth: 1
                        },
                        {
                            label: 'May',
                            data: mayData,
                            backgroundColor: '#f39c12', // Orange
                            borderColor: '#e67e22',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Top Causes Index - Top Trends (MoM)',
                            font: {
                                size: 16,
                                weight: 'bold'
                            },
                            color: '#34495e'
                        },
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#333'
                            }
                        }
                    },
                    scales: {
                        x: {
                            stacked: false,
                            title: {
                                display: true,
                                text: 'Root Cause Category',
                                color: '#333'
                            },
                            ticks: {
                                color: '#555'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Index Value',
                                color: '#333'
                            },
                            ticks: {
                                color: '#555',
                                precision: 0
                            }
                        }
                    }
                }
            });
        };

        // --- Populate Root Cause Intelligence - % Trend (Active) Table ---
        const populateRcaActiveTrendTable = (rcaActiveTrendCounts, activeTrendRiskLevels) => {
            rcaActiveTrendTableBody.innerHTML = '';

            const rootCauseCategories = Object.keys(rcaActiveTrendCounts).sort();

            if (rootCauseCategories.length === 0) {
                rcaActiveTrendTableBody.innerHTML = '<tr><td colspan="5">No active observations for root cause analysis.</td></tr>';
                return;
            }

            rootCauseCategories.forEach(category => {
                const tr = document.createElement('tr');
                const tdCategory = document.createElement('td');
                tdCategory.textContent = category;
                tr.appendChild(tdCategory);

                activeTrendRiskLevels.forEach(level => {
                    const td = document.createElement('td');
                    const count = rcaActiveTrendCounts[category][level] || ''; // Display count or empty string
                    td.textContent = count;
                    if (count > 0) {
                        td.classList.add('critical-cell'); // Apply a style if there's a count
                    }
                    tr.appendChild(td);
                });
                rcaActiveTrendTableBody.appendChild(tr);
            });
        };

        // --- Populate Root Cause Intelligence - % Trend (MoM) Table ---
        const populateRcaMomTrendTable = (rcaMomTrendCounts, rcaEndDateInput) => {
            rcaMomTrendTableBody.innerHTML = '';

            const endDate = new Date(rcaEndDateInput.value);
            const monthsToShow = [];
            for (let i = 0; i < 3; i++) { // Get last 3 months
                const date = new Date(endDate.getFullYear(), endDate.getMonth() - i, 1);
                monthsToShow.push(date.toLocaleString('en-US', { month: 'short' }));
            }
            monthsToShow.reverse(); // To display in chronological order (May, June, July)

            // Update table header for months
            const tableHeadRow = document.getElementById('rcaMomTrendTable').querySelector('thead tr');
            tableHeadRow.innerHTML = '<th>RootCauseCategory</th>';
            monthsToShow.forEach(month => {
                const th = document.createElement('th');
                th.textContent = month;
                tableHeadRow.appendChild(th);
            });


            const rootCauseCategories = Object.keys(rcaMomTrendCounts).sort();

            if (rootCauseCategories.length === 0) {
                rcaMomTrendTableBody.innerHTML = `<tr><td colspan="${1 + monthsToShow.length}">No month-over-month data for root cause analysis.</td></tr>`;
                return;
            }

            rootCauseCategories.forEach(category => {
                const tr = document.createElement('tr');
                const tdCategory = document.createElement('td');
                tdCategory.textContent = category;
                tr.appendChild(tdCategory);

                monthsToShow.forEach(month => {
                    const td = document.createElement('td');
                    const count = rcaMomTrendCounts[category][month] || ''; // Display count or empty string
                    td.textContent = count;
                    if (count > 0) {
                        td.classList.add('yellow-cell'); // Apply a style if there's a count
                    }
                    tr.appendChild(td);
                });
                rcaMomTrendTableBody.appendChild(tr);
            });
        };


        // Initialize reporting period to '--' on load
        reportPeriodStartSpan.textContent = '--';
        reportPeriodEndSpan.textContent = '--';
    });
</script>

</body>
</html>
